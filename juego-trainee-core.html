<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="juego-trainee-figura.html">
<link rel="import" href="utils-styles.html">

<dom-module id="juego-trainee-core">
  <template>
    <style include="utils-styles">
      paper-button {
        background-color: var(--color-defecto);
        width: 8rem;
        height: 8rem;
      }

      paper-button.esta-seleccionada {
        background-color: var(--color-perdedor);
      }

      paper-button.esta-seleccionada.es-ganador {
        background-color: var(--color-ganador);
      }

      paper-button span {
        font-size: 4rem;
      }
    </style> 
    <div class="d-flex justify-content-center flex-wrap">
      <template is="dom-repeat" items="{{figuras}}" as="figura">
        <paper-button class$="m-1 {{_esGanador(figura.esGanador)}} {{_estaSeleccionada(figura.estaSeleccionada)}}"
          on-click="seleccionarFigura">
          <template is="dom-if" if="[[figura.estaSeleccionada]]">
            <template is="dom-if" if="[[figura.esGanador]]">
              <span>üê±</span>
            </template>
            <template is="dom-if" if="[[!figura.esGanador]]">
              <span>üê∂</span>
            </template>
          </template>
        </paper-button>
      </template>
    </div>
  </template>

  <script>
    class JuegoTraineeCore extends Polymer.Element {

      static get is() {
        return 'juego-trainee-core';
      }

      static get properties() {
        return {
          figuras: {
            type: Array,
            value: []
          },
          cantidad: {
            type: Number,
            value: 5,
            reflectToAttribute: true
          },
          intentos: Number
        };
      }

      ready() {
        super.ready();
        this.iniciar();
      }

      _esGanador(esGanador) {
        return esGanador ? 'es-ganador' : '';
      }

      _estaSeleccionada(estaSeleccionada) {
        return estaSeleccionada ? 'esta-seleccionada' : '';
      }

      iniciar() {
        this.calcularIntentos();
        this.set('figuras', this.crearFiguras());
      }

      calcularIntentos() {
        this.set('intentos', this.cantidad - 1);
      }

      crearFiguras() {
        const cantidad = this.cantidad;
        let numerosSinRepetir = [];
        while (numerosSinRepetir.length < cantidad) {
          let numeroAleatorio = Math.floor((Math.random() * cantidad) + 1);
          if (!numerosSinRepetir.find(numero => numero === numeroAleatorio)) {
            numerosSinRepetir.push(numeroAleatorio);
          }
        }
        return numerosSinRepetir.map((numero) => ({
          esGanador: numero === 1,
          estaSeleccionada: false
        }));
      }

      seleccionarFigura(evento) {
        evento.model.set('figura.estaSeleccionada', true);
        if (evento.model.figura.esGanador) {
          this.generarEvento('ganador');
        } else {
          this.restarIntentos();
          if (this.get('intentos') === 0) {
            this.generarEvento('perdedor');
          }
        }
      }

      generarEvento(nombreEvento) {
        let evento = new CustomEvent(nombreEvento);
        this.dispatchEvent(evento);
      }

      restarIntentos() {
        let intentos = this.get('intentos');
        this.set('intentos', --intentos);
      }

      attributeChangedCallback(name, oldValue, newValue) {
        if (oldValue !== null) {
          this.iniciar();
        }
      }
      static get observedAttributes() {
        return ['cantidad'];
      }
    }
    window.customElements.define(JuegoTraineeCore.is, JuegoTraineeCore);
  </script>
</dom-module>